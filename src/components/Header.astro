---
import LanguageToggle from "./LanguageToggle.astro";
---

<header
  class="fixed top-0 z-20 flex w-full justify-center px-4 pt-4"
  data-nav-root
>
  <div
    class="nav-shell flex w-full max-w-4xl items-center justify-between gap-3 rounded-full border border-white/10 bg-slate-900/70 px-3 py-1 backdrop-blur-xl shadow-[0_18px_60px_rgba(15,23,42,0.75)]"
  >
   

    <nav
      class="desktop-nav hidden flex-1 items-center justify-center gap-1 px-1 text-sm font-medium text-slate-200 md:flex"
    >
      <a
        href="#experiencia"
        class="nav-link relative block px-2 py-2 transition hover:text-cyan-400"
        aria-label="experiencia"
      >
        <span class="i18n-es">Experiencia</span>
        <span class="i18n-en">Experience</span>
      </a>
      <a
        href="#proyectos"
        class="nav-link relative block px-2 py-2 transition hover:text-cyan-400"
        aria-label="proyectos"
      >
        <span class="i18n-es">Proyectos</span>
        <span class="i18n-en">Projects</span>
      </a>
      <a
        href="#aboutme"
        class="nav-link relative block px-2 py-2 transition hover:text-cyan-400"
        aria-label="aboutme"
      >
        <span class="i18n-es">Sobre mí</span>
        <span class="i18n-en">About me</span>
      </a>
      <a
        href="mailto:fjinfantejob@gmail.com"
        target="_blank"
        class="nav-link font-semibold relative block px-2 py-2 transition hover:text-rose-400"
        aria-label="contacto"
      >
        <span class="i18n-es">Contacto</span>
        <span class="i18n-en">Contact</span>
      </a>
    </nav>

    <div class="hidden md:block">
      <LanguageToggle />
    </div>

    <div class="md:hidden">
      <LanguageToggle />
    </div>
     <button
      type="button"
      class="hamburger inline-flex items-center justify-center rounded-full border border-white/10 bg-slate-900/80 p-2 text-slate-100 md:hidden"
      aria-label="Abrir menú de navegación"
      aria-expanded="false"
      data-nav-toggle
    >
      <span class="sr-only">Toggle navigation</span>
      <span class="hamburger-box" aria-hidden="true">
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
      </span>
    </button>
  </div>

  <nav
    class="mobile-menu md:hidden"
    data-mobile-menu
  >
    <a
      href="#experiencia"
      class="mobile-link"
      aria-label="experiencia"
    >
      <span class="i18n-es">Experiencia</span>
      <span class="i18n-en">Experience</span>
    </a>
    <a
      href="#proyectos"
      class="mobile-link"
      aria-label="proyectos"
    >
      <span class="i18n-es">Proyectos</span>
      <span class="i18n-en">Projects</span>
    </a>
    <a
      href="#aboutme"
      class="mobile-link"
      aria-label="aboutme"
    >
      <span class="i18n-es">Sobre mí</span>
      <span class="i18n-en">About me</span>
    </a>
    <a
      href="mailto:fjinfantejob@gmail.com"
      target="_blank"
      class="mobile-link"
      aria-label="contacto"
    >
      <span class="i18n-es">Contacto</span>
      <span class="i18n-en">Contact</span>
    </a>
  </nav>
</header>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const header = document.querySelector<HTMLElement>('header[data-nav-root]');
    if (!header) return;

    const sections = document.querySelectorAll<HTMLElement>("section");
    const navItems = header.querySelectorAll<HTMLAnchorElement>("nav a");
    const toggle = header.querySelector<HTMLButtonElement>("[data-nav-toggle]");
    const mobileMenu = header.querySelector<HTMLElement>("[data-mobile-menu]");

    console.log("[Header] Init", {
      sections: sections.length,
      navLinks: navItems.length,
      hasToggle: !!toggle,
      hasMobileMenu: !!mobileMenu,
    });

    const setOpen = (open: boolean) => {
      if (!header || !toggle || !mobileMenu) return;
      header.dataset.open = open ? "true" : "false";
      toggle.setAttribute("aria-expanded", open ? "true" : "false");
      console.log("[Header] Mobile menu state:", open ? "open" : "closed");
    };

    toggle?.addEventListener("click", () => {
      const isOpen = header.dataset.open === "true";
      setOpen(!isOpen);
    });

    mobileMenu?.addEventListener("click", (event) => {
      const target = event.target;
      if (!(target instanceof Element)) return;
      const link = target.closest("a");
      if (link) {
        console.log("[Header] Mobile menu link click", link.getAttribute("href"));
        setOpen(false);
      }
    });

    window.addEventListener("resize", () => {
      if (window.innerWidth >= 768) {
        console.log("[Header] Resize >= 768, closing mobile menu");
        setOpen(false);
      }
    });

    const callback = (entries: IntersectionObserverEntry[]) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          console.log(
            "[Header] Intersection callback section:",
            entry.target.id || "(no id)",
            "isIntersecting:",
            entry.isIntersecting
          );
          navItems.forEach((item) => {
            if (item.getAttribute("aria-label") === entry.target.id) {
              item.classList.add("text-green-500");
            } else {
              item.classList.remove("text-green-500");
            }
          });
        }
      });
    };

    const observer = new IntersectionObserver(callback, {
      root: null,
      rootMargin: "0px",
      threshold: 0.3,
    });

    sections.forEach((section) => {
      observer.observe(section);
    });

    document.onvisibilitychange = () => {
      if (document.visibilityState === "hidden") {
        observer.disconnect();
      } else {
        sections.forEach((section) => {
          observer.observe(section);
        });
      }
    };
  });
</script>

<style>
  .nav-shell {
    animation: nav-shadown 1s linear both;
    animation-timeline: scroll();
    animation-range: 0 100px;
  }

  @keyframes nav-shadown {
    to {
      box-shadow: 0 18px 60px rgba(15, 23, 42, 0.9);
      background-color: rgba(15, 23, 42, 0.98);
      border-color: rgba(148, 163, 184, 0.7);
      backdrop-filter: blur(20px);
    }
  }

  .mobile-menu {
    position: fixed;
    top: 4.5rem;
    right: 1rem;
    left: auto;
    width: min(260px, calc(100% - 2rem));
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    padding: 0.6rem;
    border-radius: 1rem;
    background-color: rgba(15, 23, 42, 0.96);
    border: 1px solid rgba(148, 163, 184, 0.55);
    backdrop-filter: blur(18px);
    box-shadow: 0 24px 70px rgba(15, 23, 42, 0.95);
    transform: translateY(-10px) scale(0.98);
    opacity: 0;
    pointer-events: none;
    transition:
      transform 0.22s ease,
      opacity 0.22s ease;
  }

  header[data-open="true"] .mobile-menu {
    transform: translateY(0) scale(1);
    opacity: 1;
    pointer-events: auto;
  }

  .mobile-link {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding: 0.6rem 0.85rem;
    border-radius: 0.75rem;
    font-size: 0.9rem;
    font-weight: 500;
    color: #e5e7eb;
    text-align: right;
    text-decoration: none;
    transition:
      background-color 0.18s ease,
      color 0.18s ease,
      transform 0.18s ease;
  }

  .mobile-link:hover {
    background-color: rgba(15, 118, 110, 0.35);
    color: #a5f3fc;
    transform: translateY(-1px);
  }

  .hamburger-box {
    display: flex;
    flex-direction: column;
    gap: 3px;
  }

  .hamburger-line {
    width: 18px;
    height: 2px;
    border-radius: 9999px;
    background-color: #e5e7eb;
    transition:
      transform 0.18s ease,
      opacity 0.18s ease,
      background-color 0.18s ease;
  }

  header[data-open="true"] .hamburger-line:nth-child(1) {
    transform: translateY(5px) rotate(45deg);
  }

  header[data-open="true"] .hamburger-line:nth-child(2) {
    opacity: 0;
  }

  header[data-open="true"] .hamburger-line:nth-child(3) {
    transform: translateY(-5px) rotate(-45deg);
  }

  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
  }
</style>
